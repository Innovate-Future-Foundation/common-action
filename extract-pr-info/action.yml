name: "Get PR Info with Validation"
description: "Retrieve PR info and validate commit messages for squash merges."
inputs:
  github_token:
    description: "GitHub token for authentication"
    required: true
  pr_number:
    description: "Pull Request number (optional, from dispatch input)"
    required: false
outputs:
  pr_number:
    description: "The PR number extracted or provided."
  pr_hash:
    description: "The short commit hash of the PR."
  tag:
    description: "Generated tag in the format <short_hash>_<pr_number>."
runs:
  using: "composite"
  steps:
    - id: handle_dispatch_input
      name: Handle Dispatch Input
      if: ${{ inputs.pr_number != '' }}
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
      run: |
        echo "Using dispatch input to retrieve pull request commit hash."
        PR_NUMBER=${{ inputs.pr_number }}
        PR_HASH=$(gh pr view $PR_NUMBER --json commits --jq '.commits[-1].oid' || exit 1)
        echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
        echo "pr_hash=$PR_HASH" >> $GITHUB_OUTPUT

    - id: handle_push_event
      name: Handle Push Event
      if: ${{ inputs.pr_number == '' }}
      shell: bash
      run: |
        echo "Validating current head commit message for squash merge."
        COMMIT_MESSAGE=$(git log -1 --pretty=%B | head -n 1)
        PR_NUMBER=$(echo "$COMMIT_MESSAGE" | grep -oP '\(#\K\d+')

        if [ -z "$PR_NUMBER" ]; then
          echo "Error: Commit message does not follow squash merge pattern. Aborting deployment."
          exit 1
        fi

        PR_HASH=$(git rev-parse --short HEAD)
        echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
        echo "pr_hash=$PR_HASH" >> $GITHUB_OUTPUT

    - id: generate_tag
      name: Generate Tag
      shell: bash
      run: |
        TAG="${{ steps.handle_dispatch_input.outputs.pr_hash || steps.handle_push_event.outputs.pr_hash }}_${{ steps.handle_dispatch_input.outputs.pr_number || steps.handle_push_event.outputs.pr_number }}"
        echo "tag=$TAG" >> $GITHUB_OUTPUT
